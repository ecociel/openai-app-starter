<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Table Booking</title>
    <style>
        :root { color-scheme: dark light; }
        body { color: #e8e8e8; background: transparent; font-family: sans-serif; }

        h1 { margin: 0 0 12px; font-size: 18px; color: #e8e8e8; }

        label { color: #e8e8e8; display: grid; gap: 6px; font-size: 13px; }

        input, button {
            color: #e8e8e8;
            background: #1f1f1f;
            border: 1px solid #444;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        input::placeholder { color: #a8a8a8; }

        button {
            background: #2d6cdf;
            border-color: #2d6cdf;
            cursor: pointer;
        }
        button:hover { background: #215bb3; }

        form { margin: 16px 0; display: grid; gap: 10px; max-width: 420px; }

        #confirmation {
            display: none;
            margin: 10px 0;
            padding: 10px 12px;
            border-radius: 6px;
            background: #eef9f0;
            color: #0a5b26;
            font-size: 13px;
        }

        #prefillNote {
            display: none;
            margin: 8px 0 0;
            color: #b8d4ff;
            font-size: 12px;
        }
    </style>
</head>
<body>
<h1>Table Booking</h1>

<form id="bookingForm">
    <label>
        Restaurant Name
        <input type="text" id="restaurantName" name="restaurantName" placeholder="e.g., Ocean View Diner" required />
    </label>
    <label>
        No. of Persons
        <input type="number" id="numPersons" name="numPersons" min="1" step="1" placeholder="e.g., 4" required />
    </label>
    <label>
        Date
        <input type="date" id="bookingDate" name="bookingDate" required />
    </label>
    <label>
        Time
        <input type="time" id="bookingTime" name="bookingTime" required />
    </label>
    <button type="submit">Book Table</button>
    <div id="prefillNote">Fields were prefilled from tool inputs.</div>
</form>

<div id="confirmation" role="status" aria-live="polite"></div>

<script>
    function prefillFromToolOutput() {
        const output = (window.openai && window.openai.toolOutput) || {};
        const prefilled = [];

        const prefill = (id, value) => {
            if (value !== undefined && value !== null && String(value).length > 0) {
                const el = document.getElementById(id);
                if (el) {
                    el.value = String(value);
                    prefilled.push(id);
                }
            }
        };

        prefill("restaurantName", output.restaurantName);
        prefill("numPersons", output.numPersons);
        prefill("bookingDate", output.date);
        prefill("bookingTime", output.time);

        if (prefilled.length > 0) {
            const note = document.getElementById("prefillNote");
            if (note) note.style.display = "block";
            return true;
        }
        return false;
    }

    (function setupForm() {
        const form = document.getElementById("bookingForm");
        const confirmation = document.getElementById("confirmation");
        if (!form || !confirmation) return;

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const restaurantName = document.getElementById("restaurantName").value.trim();
            const numPersons = document.getElementById("numPersons").value;
            const bookingDate = document.getElementById("bookingDate").value;
            const bookingTime = document.getElementById("bookingTime").value;

            try {
                const res = await fetch("https://untaxied-subintroductive-sadye.ngrok-free.dev/api/bookings", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        restaurantName,
                        numPersons,
                        date: bookingDate,
                        time: bookingTime
                    })
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.detail || `HTTP ${res.status}`);
                }

                const data = await res.json();
                confirmation.style.display = "block";
                confirmation.style.background = "#eef9f0";
                confirmation.style.color = "#0a5b26";
                confirmation.textContent = `Table reserved - (Booking id: ${data.id})`;
            } catch (err) {
                confirmation.style.display = "block";
                confirmation.style.background = "#fdecea";
                confirmation.style.color = "#611a15";
                confirmation.textContent = `Table booking failed: ${err}`;
            }


            // confirmation.textContent =
            //     `Booking submitted â€” Restaurant: ${restaurantName}; Persons: ${numPersons}; Date: ${bookingDate}; Time: ${bookingTime}`;
            // confirmation.style.display = "block";
        });
    })();

    if (!prefillFromToolOutput()) {
        const timer = setInterval(() => prefillFromToolOutput() && clearInterval(timer), 200);
        document.addEventListener("visibilitychange", () => !document.hidden && prefillFromToolOutput());
    }
</script>
</body>
</html>